{% extends "layout.html" %}
{% block title %}Token - {{ paciente.nome }}{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
  <h2 class="text-2xl font-bold text-sabaraBlue">Atendimento: {{ paciente.nome }} ({{ paciente.id }})</h2>
  <a href="/paciente/selecionar" class="text-sm bg-gray-200 px-3 py-1 rounded">Trocar Paciente</a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Cards de estoque (2/3 da largura) -->
  <div class="lg:col-span-2">
    <div id="cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
      {% for it in estoque %}
      <div class="border rounded-lg p-4 bg-white shadow">
        <div class="font-semibold">{{ it.nome }}</div>
        <div class="text-sm text-gray-600">{{ it.tipo }} • Disponível: <span id="stock-{{ it.id }}">{{ it.quantidade }}</span></div>
        <div class="mt-3 flex items-center justify-between">
          <div class="text-sm">R$ {{ '%.2f'|format(it.cost_patient/100) }}</div>
          <div class="flex items-center gap-2">
            <button class="px-2 py-1 bg-gray-200 rounded decrease-btn" data-id="{{ it.id }}">−</button>
            <span id="qty-{{ it.id }}">0</span>
            <button class="px-2 py-1 bg-gray-200 rounded increase-btn" data-id="{{ it.id }}">+</button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Painel de resumo (1/3 da largura) -->
  <div>
    <div class="bg-white p-4 rounded-lg shadow">
      <h3 class="font-semibold mb-2">Resumo (temporário)</h3>
      <div id="resumo-list" class="space-y-2">
        <!-- preenchido via JS -->
      </div>
      <div class="mt-4">
        <div class="flex justify-between">
          <div class="font-semibold">Total</div>
          <div id="total">R$ 0.00</div>
        </div>
        <div class="mt-4 flex gap-2">
          <a id="btn-resumo" href="#" class="bg-sabaraBlue text-white px-4 py-2 rounded w-full text-center">Ir para Resumo</a>
          <button id="btn-clear" class="bg-gray-300 px-4 py-2 rounded">Limpar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const pacienteId = "{{ paciente.id }}";

async function getPendente() {
  const res = await fetch(`/token/api/pendente/${pacienteId}`);
  return await res.json();
}

async function refreshResumoUI() {
  const pend = await getPendente();
  const listEl = document.getElementById("resumo-list");
  listEl.innerHTML = "";
  let total = 0;
  for (const it of pend.items) {
    const row = document.createElement("div");
    row.className = "flex justify-between items-center";
    const subtotal = (it.qty * it.unit_price) / 100;
    total += it.qty * it.unit_price;
    row.innerHTML = `<div>${it.nome} x ${it.qty}</div><div>R$ ${subtotal.toFixed(2)}</div>`;
    listEl.appendChild(row);
    // atualiza qty label no card
    const qtySpan = document.getElementById("qty-"+it.id);
    if (qtySpan) qtySpan.innerText = it.qty;
  }
  // atualiza total
  document.getElementById("total").innerText = "R$ " + (total/100).toFixed(2);
}

document.addEventListener("DOMContentLoaded", async () => {
  // anexa handlers a todos os botões + e -
  document.querySelectorAll(".increase-btn").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const id = e.currentTarget.dataset.id;
      // adiciona 1
      await fetch(`/token/api/pendente/${pacienteId}/add`, {
        method: "POST",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({item_id: id, qty: 1})
      });
      // atualiza UI counts
      const qtySpan = document.getElementById("qty-"+id);
      qtySpan.innerText = parseInt(qtySpan.innerText || "0") + 1;
      // decrementa visual stock
      const stockSpan = document.getElementById("stock-"+id);
      stockSpan.innerText = parseInt(stockSpan.innerText) - 1;
      await refreshResumoUI();
    });
  });

  // Bloco para diminuir quanridade 'decrease-btn'
  document.querySelectorAll(".decrease-btn").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const id = e.currentTarget.dataset.id;
      const qtySpan = document.getElementById("qty-"+id);
      const currentQty = parseInt(qtySpan.innerText || "0");

      // Se a quantidade já for 0, não faz nada.
      if (currentQty <= 0) {
        return; 
      }

      await fetch(`/token/api/pendente/${pacienteId}/remove`, {
        method: "POST",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({item_id: id, qty: 1})
      });
      
      // Atualiza a UI (agora só executa se currentQty > 0) para não diminuir além do necessário
      qtySpan.innerText = currentQty - 1; 
      
      const stockSpan = document.getElementById("stock-"+id);
      stockSpan.innerText = parseInt(stockSpan.innerText) + 1;
      await refreshResumoUI();
    });
  });

  document.getElementById("btn-clear").addEventListener("click", async () => {
    await fetch(`/token/api/pendente/${pacienteId}/clear`, {method:"POST"});
    // zera UI qtys
    document.querySelectorAll("[id^='qty-']").forEach(el => el.innerText = "0");
    // recarrega cards do servidor para mostrar estoque corretos
    location.reload();
  });

  document.getElementById("btn-resumo").addEventListener("click", (e) => {
    e.preventDefault();
    window.location.href = `/resumo/${pacienteId}`;
  });

  // inicializa resumo
  await refreshResumoUI();
});
</script>
{% endblock %}
